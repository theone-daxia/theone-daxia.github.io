<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Golang内存管理和垃圾回收 | 冲和</title><meta name=keywords content="go 内存管理,go gc"><meta name=description content="前言 网上有很多讲 go gc 的文章，但大多讲的不明不白， 一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。 好在最近在公众号看到了一篇文章，我觉得写的很赞， 起码解答了那些突然出现的术语是什么。
我决定把它搬运到这里，手写一遍记忆更加深刻。 接下来是对原文的默写，忘了就直接抄写。
原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入， 出入的地方我就改贴上我本地的 go 源代码。 所有图片都来源于原文，原文地址在最下面参考文献中列出。 默写加抄写 本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。
一、TCMalloc go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc， 是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。
(一) Page 操作系统对内存的管理以页为单位，TCMalloc 也是这样， 只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。
(二) Span 一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。 Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域， Span 是 TCMalloc 中内存管理的基本单位。"><meta name=author content="冲和"><link rel=canonical href=https://theone-daxia.github.io/blog/code/go/gc/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://theone-daxia.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://theone-daxia.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://theone-daxia.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://theone-daxia.github.io/apple-touch-icon.png><link rel=mask-icon href=https://theone-daxia.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.108.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-YBNN92PXEM"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YBNN92PXEM",{anonymize_ip:!1})}</script><meta property="og:title" content="Golang内存管理和垃圾回收"><meta property="og:description" content="前言 网上有很多讲 go gc 的文章，但大多讲的不明不白， 一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。 好在最近在公众号看到了一篇文章，我觉得写的很赞， 起码解答了那些突然出现的术语是什么。
我决定把它搬运到这里，手写一遍记忆更加深刻。 接下来是对原文的默写，忘了就直接抄写。
原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入， 出入的地方我就改贴上我本地的 go 源代码。 所有图片都来源于原文，原文地址在最下面参考文献中列出。 默写加抄写 本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。
一、TCMalloc go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc， 是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。
(一) Page 操作系统对内存的管理以页为单位，TCMalloc 也是这样， 只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。
(二) Span 一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。 Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域， Span 是 TCMalloc 中内存管理的基本单位。"><meta property="og:type" content="article"><meta property="og:url" content="https://theone-daxia.github.io/blog/code/go/gc/"><meta property="og:image" content="https://theone-daxia.github.io/papermod-cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-12-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://theone-daxia.github.io/papermod-cover.png"><meta name=twitter:title content="Golang内存管理和垃圾回收"><meta name=twitter:description content="前言 网上有很多讲 go gc 的文章，但大多讲的不明不白， 一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。 好在最近在公众号看到了一篇文章，我觉得写的很赞， 起码解答了那些突然出现的术语是什么。
我决定把它搬运到这里，手写一遍记忆更加深刻。 接下来是对原文的默写，忘了就直接抄写。
原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入， 出入的地方我就改贴上我本地的 go 源代码。 所有图片都来源于原文，原文地址在最下面参考文献中列出。 默写加抄写 本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。
一、TCMalloc go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc， 是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。
(一) Page 操作系统对内存的管理以页为单位，TCMalloc 也是这样， 只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。
(二) Span 一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。 Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域， Span 是 TCMalloc 中内存管理的基本单位。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://theone-daxia.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Golang内存管理和垃圾回收","item":"https://theone-daxia.github.io/blog/code/go/gc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golang内存管理和垃圾回收","name":"Golang内存管理和垃圾回收","description":"前言 网上有很多讲 go gc 的文章，但大多讲的不明不白， 一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。 好在最近在公众号看到了一篇文章，我觉得写的很赞， 起码解答了那些突然出现的术语是什么。\n我决定把它搬运到这里，手写一遍记忆更加深刻。 接下来是对原文的默写，忘了就直接抄写。\n原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入， 出入的地方我就改贴上我本地的 go 源代码。 所有图片都来源于原文，原文地址在最下面参考文献中列出。 默写加抄写 本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。\n一、TCMalloc go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc， 是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。\n(一) Page 操作系统对内存的管理以页为单位，TCMalloc 也是这样， 只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。\n(二) Span 一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。 Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域， Span 是 TCMalloc 中内存管理的基本单位。","keywords":["go 内存管理","go gc"],"articleBody":"前言 网上有很多讲 go gc 的文章，但大多讲的不明不白， 一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。 好在最近在公众号看到了一篇文章，我觉得写的很赞， 起码解答了那些突然出现的术语是什么。\n我决定把它搬运到这里，手写一遍记忆更加深刻。 接下来是对原文的默写，忘了就直接抄写。\n原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入， 出入的地方我就改贴上我本地的 go 源代码。 所有图片都来源于原文，原文地址在最下面参考文献中列出。 默写加抄写 本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。\n一、TCMalloc go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc， 是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。\n(一) Page 操作系统对内存的管理以页为单位，TCMalloc 也是这样， 只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。\n(二) Span 一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。 Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域， Span 是 TCMalloc 中内存管理的基本单位。\n(三) ThreadCache 每个线程各自的 Cache，一个 Cache 包含多个空闲的内存块链表， 同一个链表上的内存块大小相同，也可以说按内存块大小，给内存块分了个类， 这样可以根据申请的内存大小，快速从合适的链表上选择空闲内存块。 由于每个线程都有自己的 ThreadCache，所以 ThreadCache 的访问是无锁的。\n(四) CentralCache 是所有线程共享的缓存，也是保存的空闲内存块链表， 链表的数量和 ThreadCache 中链表的数量相同。 当 ThreadCache 内存块不足时，可以从 CentralCache 取， 当 ThreadCache 内存块多时，可以放回 CentralCache。 由于 CentralCache 是共享的，所以它的访问是要加锁的。\n(五) PageHeap PageHeap 是堆内存的抽象，存的也是若干链表，链表保存的是 Span， 当 CentralCache 没有内存时，会从 PageHeap 取， 把一个 Span 拆成若干内存块，添加到对应大小的链表中， 当 CentralCache 内存多时，会放回 PageHeap。\n(六) TCMalloc 对象分配 小对象直接从 ThreadCache 分配， 若 ThreadCache 不够，则从 CentralCache 中获取内存， 若 CentralCache 不够，则从 PageHeap 中获取内存； 大对象在 PageHeap 中选取合适的页组成 Span 用于存储数据。\n二、go 内存管理 go 内存管理架构取之 TCMalloc，不过在细节上有些出入， 先来看一张 go 内存管理架构图：\n(一) Page 和 TCMalloc 中的 Page 相同，上图中最下方浅蓝色长方形代表一个 Page。\n(二) Span 与 TCMalloc 中的 Span 相同，Span 是 go 内存管理的基本单位，代码中为 mspan， 一组连续的 Page 组成一个 Span。\n(三) mcache mcache 与 TCMalloc 中的 ThreadCache 类似，mcache 保存的是各种大小的 Span， 并按 Span class 分类，小对象直接从 mcache 分配内存，它起到了缓存的作用， 并且可以无锁访问。\n但 mcache 和 ThreadCache 也有不同点，TCMalloc 中是每个线程一个 ThreadCache， go 中是每个 P 拥有一个 mcache，因为在 go 程序中，当前最多有 GOMAXPROCS 个线程在运行， 所以最多需要 GOMAXPROCS 个 mcache 就可以保证各线程对 mcache 的无锁访问。 下图是 G、P、M 三者之间的关系：\n(四) mcentral mcentral 与 TCMalloc 中的 CentralCache 类似，是所有线程共享的缓存，需要加锁访问。 它按 Span class 对 Span 分类，串联成链表，当 mcache 的某个级别 Span 的内存被分配光时， 它会向 mcentral 申请一个当前级别的 Span。\n但 mcentral 与 CentralCache 也有不同点， CentralCache 是每个级别的 Span 有一个链表， mcentral 是每个级别的 Span 有两个链表。\n(五) mheap mheap 与 TCMalloc 的 PageHeap 类似，它是堆内存的抽象，把从 OS 申请出的内存页组织成 Span， 并保存起来。当 mcentral 的 Span 不够用时会向 mheap 申请， mheap 的 Span 不够用时会向 OS 申请，把从 OS 申请的内存页生成 Span 组织起来，需要加锁访问。\n但 mheap 与 PageHeap 也有不同点， mheap 把 Span 组织成了树结构，而不是链表，并且还是两棵树， 然后把 Span 分配到 heapArena 进行管理，它包含地址映射和 Span 是否包含指针等位图， 这样做的主要原因是为了更高效的利用内存：分配、回收和再利用。\n(六) 内存分配 TCMalloc 的内存分类分为：小、中、大对象， go 分为：Tiny、小、大对象。 Tiny 对象指大小在 1Byte 到 16Byte 之间且不包含指针的对象。 小对象和大对象只用大小划定，无其他区分， 小对象大小在 16Byte 到 32KB 之间， 大对象大小大于 32KB。\ngo 的内存管理基本单位是 Span，且 Span 有不同的规格，想要区分出不同的 Span， 就得有个标识，每个 Span 通过 spanclass 标识属于哪种规格的 Span， go 的 Span 一共有 67 种，具体如下：\n// from runtime/sizeclasses.go // class bytes/obj bytes/span objects tail waste max waste min align // 1 8 8192 1024 0 87.50% 8 // 2 16 8192 512 0 43.75% 16 // 3 24 8192 341 8 29.24% 8 // 4 32 8192 256 0 21.88% 32 // 5 48 8192 170 32 31.52% 16 // 6 64 8192 128 0 23.44% 64 // 7 80 8192 102 32 19.07% 16 // 8 96 8192 85 32 15.95% 32 // 9 112 8192 73 16 13.56% 16 // 10 128 8192 64 0 11.72% 128 // 11 144 8192 56 128 11.82% 16 // 12 160 8192 51 32 9.73% 32 // 13 176 8192 46 96 9.59% 16 // 14 192 8192 42 128 9.25% 64 // 15 208 8192 39 80 8.12% 16 // 16 224 8192 36 128 8.15% 32 // 17 240 8192 34 32 6.62% 16 // 18 256 8192 32 0 5.86% 256 // 19 288 8192 28 128 12.16% 32 // 20 320 8192 25 192 11.80% 64 // 21 352 8192 23 96 9.88% 32 // 22 384 8192 21 128 9.51% 128 // 23 416 8192 19 288 10.71% 32 // 24 448 8192 18 128 8.37% 64 // 25 480 8192 17 32 6.82% 32 // 26 512 8192 16 0 6.05% 512 // 27 576 8192 14 128 12.33% 64 // 28 640 8192 12 512 15.48% 128 // 29 704 8192 11 448 13.93% 64 // 30 768 8192 10 512 13.94% 256 // 31 896 8192 9 128 15.52% 128 // 32 1024 8192 8 0 12.40% 1024 // 33 1152 8192 7 128 12.41% 128 // 34 1280 8192 6 512 15.55% 256 // 35 1408 16384 11 896 14.00% 128 // 36 1536 8192 5 512 14.00% 512 // 37 1792 16384 9 256 15.57% 256 // 38 2048 8192 4 0 12.45% 2048 // 39 2304 16384 7 256 12.46% 256 // 40 2688 8192 3 128 15.59% 128 // 41 3072 24576 8 0 12.47% 1024 // 42 3200 16384 5 384 6.22% 128 // 43 3456 24576 7 384 8.83% 128 // 44 4096 8192 2 0 15.60% 4096 // 45 4864 24576 5 256 16.65% 256 // 46 5376 16384 3 256 10.92% 256 // 47 6144 24576 4 0 12.48% 2048 // 48 6528 32768 5 128 6.23% 128 // 49 6784 40960 6 256 4.36% 128 // 50 6912 49152 7 768 3.37% 256 // 51 8192 8192 1 0 15.61% 8192 // 52 9472 57344 6 512 14.28% 256 // 53 9728 49152 5 512 3.64% 512 // 54 10240 40960 4 0 4.99% 2048 // 55 10880 32768 3 128 6.24% 128 // 56 12288 24576 2 0 11.45% 4096 // 57 13568 40960 3 256 9.99% 256 // 58 14336 57344 4 0 5.35% 2048 // 59 16384 16384 1 0 12.49% 8192 // 60 18432 73728 4 0 11.11% 2048 // 61 19072 57344 3 128 3.57% 128 // 62 20480 40960 2 0 6.87% 4096 // 63 21760 65536 3 256 6.25% 256 // 64 24576 24576 1 0 11.45% 8192 // 65 27264 81920 3 128 10.00% 128 // 66 28672 57344 2 0 4.91% 4096 // 67 32768 32768 1 0 12.50% 8192 由上表可见，最大的对象大小为 32KB，超过 32KB 大小的由特殊 class 表示， 该 class ID 为 0，每个 class 只包含一个对象。\n内存大小转换，有 3 个数组，对应下图中的三个箭头：\nclass_to_size size_to_class class_to_allocnpages class 1 的对象大小为 8Byte，所以 class_to_size[1] = 8； span 大小是 8KB，为 1 页（因为 go 内存管理以 8KB 为一页）， 所以 class_to_allocnpages[1] = 1，下面是源码中大小转换数组：\nconst ( _MaxSmallSize = 32768 smallSizeDiv = 8 smallSizeMax = 1024 largeSizeDiv = 128 _NumSizeClasses = 68 _PageShift = 13 ) var class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 24, 32, 48, 64, 80, 96, 112, 128, 144, 160, 176, 192, 208, 224, 240, 256, 288, 320, 352, 384, 416, 448, 480, 512, 576, 640, 704, 768, 896, 1024, 1152, 1280, 1408, 1536, 1792, 2048, 2304, 2688, 3072, 3200, 3456, 4096, 4864, 5376, 6144, 6528, 6784, 6912, 8192, 9472, 9728, 10240, 10880, 12288, 13568, 14336, 16384, 18432, 19072, 20480, 21760, 24576, 27264, 28672, 32768} var class_to_allocnpages = [_NumSizeClasses]uint8{0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 1, 2, 1, 3, 2, 3, 1, 3, 2, 3, 4, 5, 6, 1, 7, 6, 5, 4, 3, 5, 7, 2, 9, 7, 5, 8, 3, 10, 7, 4} var class_to_divmagic = [_NumSizeClasses]uint32{0, ^uint32(0)/8 + 1, ^uint32(0)/16 + 1, ^uint32(0)/24 + 1, ^uint32(0)/32 + 1, ^uint32(0)/48 + 1, ^uint32(0)/64 + 1, ^uint32(0)/80 + 1, ^uint32(0)/96 + 1, ^uint32(0)/112 + 1, ^uint32(0)/128 + 1, ^uint32(0)/144 + 1, ^uint32(0)/160 + 1, ^uint32(0)/176 + 1, ^uint32(0)/192 + 1, ^uint32(0)/208 + 1, ^uint32(0)/224 + 1, ^uint32(0)/240 + 1, ^uint32(0)/256 + 1, ^uint32(0)/288 + 1, ^uint32(0)/320 + 1, ^uint32(0)/352 + 1, ^uint32(0)/384 + 1, ^uint32(0)/416 + 1, ^uint32(0)/448 + 1, ^uint32(0)/480 + 1, ^uint32(0)/512 + 1, ^uint32(0)/576 + 1, ^uint32(0)/640 + 1, ^uint32(0)/704 + 1, ^uint32(0)/768 + 1, ^uint32(0)/896 + 1, ^uint32(0)/1024 + 1, ^uint32(0)/1152 + 1, ^uint32(0)/1280 + 1, ^uint32(0)/1408 + 1, ^uint32(0)/1536 + 1, ^uint32(0)/1792 + 1, ^uint32(0)/2048 + 1, ^uint32(0)/2304 + 1, ^uint32(0)/2688 + 1, ^uint32(0)/3072 + 1, ^uint32(0)/3200 + 1, ^uint32(0)/3456 + 1, ^uint32(0)/4096 + 1, ^uint32(0)/4864 + 1, ^uint32(0)/5376 + 1, ^uint32(0)/6144 + 1, ^uint32(0)/6528 + 1, ^uint32(0)/6784 + 1, ^uint32(0)/6912 + 1, ^uint32(0)/8192 + 1, ^uint32(0)/9472 + 1, ^uint32(0)/9728 + 1, ^uint32(0)/10240 + 1, ^uint32(0)/10880 + 1, ^uint32(0)/12288 + 1, ^uint32(0)/13568 + 1, ^uint32(0)/14336 + 1, ^uint32(0)/16384 + 1, ^uint32(0)/18432 + 1, ^uint32(0)/19072 + 1, ^uint32(0)/20480 + 1, ^uint32(0)/21760 + 1, ^uint32(0)/24576 + 1, ^uint32(0)/27264 + 1, ^uint32(0)/28672 + 1, ^uint32(0)/32768 + 1} var size_to_class8 = [smallSizeMax/smallSizeDiv + 1]uint8{0, 1, 2, 3, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 27, 27, 27, 27, 27, 27, 27, 27, 28, 28, 28, 28, 28, 28, 28, 28, 29, 29, 29, 29, 29, 29, 29, 29, 30, 30, 30, 30, 30, 30, 30, 30, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32} var size_to_class128 = [(_MaxSmallSize-smallSizeMax)/largeSizeDiv + 1]uint8{32, 33, 34, 35, 36, 37, 37, 38, 38, 39, 39, 40, 40, 40, 41, 41, 41, 42, 43, 43, 44, 44, 44, 44, 44, 45, 45, 45, 45, 45, 45, 46, 46, 46, 46, 47, 47, 47, 47, 47, 47, 48, 48, 48, 49, 49, 50, 51, 51, 51, 51, 51, 51, 51, 51, 51, 51, 52, 52, 52, 52, 52, 52, 52, 52, 52, 52, 53, 53, 54, 54, 54, 54, 55, 55, 55, 55, 55, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 57, 57, 57, 57, 57, 57, 57, 57, 57, 57, 58, 58, 58, 58, 58, 58, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 61, 61, 61, 61, 61, 62, 62, 62, 62, 62, 62, 62, 62, 62, 62, 62, 63, 63, 63, 63, 63, 63, 63, 63, 63, 63, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 66, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67} 为对象寻找 Span 的流程如下：\n计算对象所需内存大小 size。 根据 size 到 size class 映射，得到 size class。 根据 size class 和对象是否包含指针，得到 span class。 获取该 span class 指向的 span。 以分配一个包含指针，大小为 20Byte 的对象为例，根据映射表， size class 3，它的对象大小范围是 (16, 24]Byte，20Byte 刚好在这之间， 所以此对象的 size class 为 3，size class 到 span class 的计算如下：\ntype spanClass uint8 // noscan 为 false 代表对象包含指针 func makeSpanClass(sizeclass uint8, noscan bool) spanClass { return spanClass(sizeclass\u003c\u003c1) | spanClass(bool2int(noscan)) } 所以对应的 span class 为：\nspan class = 3\u003c\u003c1 | 0 // 即 110 | 000 = 6 所以该对象需要的是 span class 6 指向的 span，自此，小对象内存分配完成。\n源码中三段分别针对 tiny、小、大对象进行分配，下面只详细贴出小对象分配内存的代码：\nif size \u003c= maxSmallSize { if noscan \u0026\u0026 size \u003c maxTinySize { // tiny 对象分配 (\u003c 16B) ... } else { // 小对象分配 (16B ~ 32KB) var sizeclass uint8 // 先计算 sizeclass if size \u003c= smallSizeMax-8 { sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)] } else { sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)] } size = uintptr(class_to_size[sizeclass]) // 再计算 span class spc := makeSpanClass(sizeclass, noscan) // 分配对应的 span (是一个 *mspan) span = c.alloc[spc] v := nextFreeFast(span) if v == 0 { v, span, shouldhelpgc = c.nextFree(spc) } x = unsafe.Pointer(v) if needzero \u0026\u0026 span.needzero != 0 { memclrNoHeapPointers(unsafe.Pointer(v), size) } } } else { // 大对象分配 (\u003e 32KB) ... span = c.allocLarge(size, noscan) ... } 大对象（\u003e 32KB）直接在 mheap 上分配，首先计算出需要的内存页数和 span class， 然后优先从 free 中搜索可用的 span，如果没找到，会从 scav 中搜索可用的 span， 如果还没找到，则向 OS 申请内存，再重新搜索两棵树，必然能找到 span。 如果找到的 span 比需要的 span 大，则把 span 分割成 2 个 span， 一个刚好是需求大小，把剩下的 span 再加入到 free 中去。\n// from runtime/mcache.go func (c *mcache) allocLarge(size uintptr, noscan bool) *mspan { if size+_PageSize \u003c size { throw(\"out of memory\") } // _PageShift = 13，从这里就能看出一页是 8KB npages := size \u003e\u003e _PageShift if size\u0026_PageMask != 0 { npages++ } // Deduct credit for this span allocation and sweep if // necessary. mHeap_Alloc will also sweep npages, so this only // pays the debt down to npage pages. deductSweepCredit(npages*_PageSize, npages) spc := makeSpanClass(0, noscan) s := mheap_.alloc(npages, spc) if s == nil { throw(\"out of memory\") } stats := memstats.heapStats.acquire() atomic.Xadduintptr(\u0026stats.largeAlloc, npages*pageSize) atomic.Xadduintptr(\u0026stats.largeAllocCount, 1) memstats.heapStats.release() // Update heapLive. gcController.update(int64(s.npages*pageSize), 0) // Put the large span in the mcentral swept list so that it's // visible to the background sweeper. mheap_.central[spc].mcentral.fullSwept(mheap_.sweepgen).push(s) s.limit = s.base() + size heapBitsForAddr(s.base()).initSpan(s) return s } 三、垃圾回收 (一) 标记-清除 (二) 三色可达性分析 (三) gc 触发 (四) gc 过程 gcStart Mark Sweep 参考文献 超干货！彻底搞懂Golang内存管理和垃圾回收 ","wordCount":"2051","inLanguage":"en","datePublished":"2022-12-01T00:00:00Z","dateModified":"2022-12-01T00:00:00Z","author":{"@type":"Person","name":"冲和"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://theone-daxia.github.io/blog/code/go/gc/"},"publisher":{"@type":"Organization","name":"冲和","logo":{"@type":"ImageObject","url":"https://theone-daxia.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://theone-daxia.github.io/ accesskey=h title="冲和 (Alt + H)">冲和</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://theone-daxia.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://theone-daxia.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://theone-daxia.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://theone-daxia.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://theone-daxia.github.io/follow_me title=关注我><span>关注我</span></a></li><li><a href=https://theone-daxia.github.io/blog/medical_beauty/project/ title=医美专区><span>医美专区</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://theone-daxia.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://theone-daxia.github.io/blog/>Blogs</a></div><h1 class=post-title>Golang内存管理和垃圾回收</h1><div class=post-meta><span title='2022-12-01 00:00:00 +0000 UTC'>December 1, 2022</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;冲和</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e9%bb%98%e5%86%99%e5%8a%a0%e6%8a%84%e5%86%99 aria-label=默写加抄写>默写加抄写</a><ul><li><a href=#%e4%b8%80tcmalloc aria-label=一、TCMalloc>一、TCMalloc</a><ul><li><a href=#%e4%b8%80-page aria-label="(一) Page">(一) Page</a></li><li><a href=#%e4%ba%8c-span aria-label="(二) Span">(二) Span</a></li><li><a href=#%e4%b8%89-threadcache aria-label="(三) ThreadCache">(三) ThreadCache</a></li><li><a href=#%e5%9b%9b-centralcache aria-label="(四) CentralCache">(四) CentralCache</a></li><li><a href=#%e4%ba%94-pageheap aria-label="(五) PageHeap">(五) PageHeap</a></li><li><a href=#%e5%85%ad-tcmalloc-%e5%af%b9%e8%b1%a1%e5%88%86%e9%85%8d aria-label="(六) TCMalloc 对象分配">(六) TCMalloc 对象分配</a></li></ul></li><li><a href=#%e4%ba%8cgo-%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86 aria-label="二、go 内存管理">二、go 内存管理</a><ul><li><a href=#%e4%b8%80-page-1 aria-label="(一) Page">(一) Page</a></li><li><a href=#%e4%ba%8c-span-1 aria-label="(二) Span">(二) Span</a></li><li><a href=#%e4%b8%89-mcache aria-label="(三) mcache">(三) mcache</a></li><li><a href=#%e5%9b%9b-mcentral aria-label="(四) mcentral">(四) mcentral</a></li><li><a href=#%e4%ba%94-mheap aria-label="(五) mheap">(五) mheap</a></li><li><a href=#%e5%85%ad-%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d aria-label="(六) 内存分配">(六) 内存分配</a></li></ul></li><li><a href=#%e4%b8%89%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6 aria-label=三、垃圾回收>三、垃圾回收</a><ul><li><a href=#%e4%b8%80-%e6%a0%87%e8%ae%b0-%e6%b8%85%e9%99%a4 aria-label="(一) 标记-清除">(一) 标记-清除</a></li><li><a href=#%e4%ba%8c-%e4%b8%89%e8%89%b2%e5%8f%af%e8%be%be%e6%80%a7%e5%88%86%e6%9e%90 aria-label="(二) 三色可达性分析">(二) 三色可达性分析</a></li><li><a href=#%e4%b8%89-gc-%e8%a7%a6%e5%8f%91 aria-label="(三) gc 触发">(三) gc 触发</a></li><li><a href=#%e5%9b%9b-gc-%e8%bf%87%e7%a8%8b aria-label="(四) gc 过程">(四) gc 过程</a></li></ul></li></ul></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae aria-label=参考文献>参考文献</a></li></ul></div></details></div><div class=post-content><h1 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h1><p>网上有很多讲 go gc 的文章，但大多讲的不明不白，
一些突然出现的术语更是不知从何而起，导致看过一些文章后对 gc 依旧云里雾里。
好在最近在公众号看到了一篇文章，我觉得写的很赞，
起码解答了那些突然出现的术语是什么。</p><p>我决定把它搬运到这里，手写一遍记忆更加深刻。
接下来是对原文的默写，忘了就直接抄写。</p><ul><li>原文中会贴出一些 go 的源代码，我本地 go 版本是 1.18.2，对照看的时候会有些出入，
出入的地方我就改贴上我本地的 go 源代码。</li><li>所有图片都来源于原文，原文地址在最下面参考文献中列出。</li></ul><h1 id=默写加抄写>默写加抄写<a hidden class=anchor aria-hidden=true href=#默写加抄写>#</a></h1><p>本文以 go 内存管理为切入点，再到 go 垃圾回收，系统的讲解了 go 自动内存管理系统的设计和原理。</p><h2 id=一tcmalloc>一、TCMalloc<a hidden class=anchor aria-hidden=true href=#一tcmalloc>#</a></h2><p>go 的内存管理借鉴了 TCMalloc 的设计思想，TCMalloc 全称 Thread-Caching Malloc，
是 google 开发的内存分配器，为了方便理解 go 的内存管理，有必要先熟悉下 TCMalloc。</p><p><img loading=lazy src=/img/code/go-gc/TCMalloc.png alt=TCMalloc></p><h3 id=一-page>(一) Page<a hidden class=anchor aria-hidden=true href=#一-page>#</a></h3><p>操作系统对内存的管理以页为单位，TCMalloc 也是这样，
只不过 TCMalloc 里的 Page 大小与操作系统里的大小不一定相等，是倍数的关系。</p><h3 id=二-span>(二) Span<a hidden class=anchor aria-hidden=true href=#二-span>#</a></h3><p>一组连续的 Page 称为 Span，比如可以有 4 个页大小的 Span，也可以有 8 个页大小的 Span。
Span 比 Page 高一个层级，是为了方便管理一定大小的内存区域，
Span 是 TCMalloc 中内存管理的基本单位。</p><h3 id=三-threadcache>(三) ThreadCache<a hidden class=anchor aria-hidden=true href=#三-threadcache>#</a></h3><p>每个线程各自的 Cache，一个 Cache 包含多个空闲的内存块链表，
同一个链表上的内存块大小相同，也可以说按内存块大小，给内存块分了个类，
这样可以根据申请的内存大小，快速从合适的链表上选择空闲内存块。
由于每个线程都有自己的 ThreadCache，所以 ThreadCache 的访问是无锁的。</p><h3 id=四-centralcache>(四) CentralCache<a hidden class=anchor aria-hidden=true href=#四-centralcache>#</a></h3><p>是所有线程共享的缓存，也是保存的空闲内存块链表，
链表的数量和 ThreadCache 中链表的数量相同。
当 ThreadCache 内存块不足时，可以从 CentralCache 取，
当 ThreadCache 内存块多时，可以放回 CentralCache。
由于 CentralCache 是共享的，所以它的访问是要加锁的。</p><h3 id=五-pageheap>(五) PageHeap<a hidden class=anchor aria-hidden=true href=#五-pageheap>#</a></h3><p>PageHeap 是堆内存的抽象，存的也是若干链表，链表保存的是 Span，
当 CentralCache 没有内存时，会从 PageHeap 取，
把一个 Span 拆成若干内存块，添加到对应大小的链表中，
当 CentralCache 内存多时，会放回 PageHeap。</p><h3 id=六-tcmalloc-对象分配>(六) TCMalloc 对象分配<a hidden class=anchor aria-hidden=true href=#六-tcmalloc-对象分配>#</a></h3><p>小对象直接从 ThreadCache 分配，
若 ThreadCache 不够，则从 CentralCache 中获取内存，
若 CentralCache 不够，则从 PageHeap 中获取内存；
大对象在 PageHeap 中选取合适的页组成 Span 用于存储数据。</p><h2 id=二go-内存管理>二、go 内存管理<a hidden class=anchor aria-hidden=true href=#二go-内存管理>#</a></h2><p>go 内存管理架构取之 TCMalloc，不过在细节上有些出入，
先来看一张 go 内存管理架构图：</p><p><img loading=lazy src=/img/code/go-gc/go-memory-manage.png alt="go 内存管理"></p><h3 id=一-page-1>(一) Page<a hidden class=anchor aria-hidden=true href=#一-page-1>#</a></h3><p>和 TCMalloc 中的 Page 相同，上图中最下方浅蓝色长方形代表一个 Page。</p><h3 id=二-span-1>(二) Span<a hidden class=anchor aria-hidden=true href=#二-span-1>#</a></h3><p>与 TCMalloc 中的 Span 相同，Span 是 go 内存管理的基本单位，代码中为 mspan，
一组连续的 Page 组成一个 Span。</p><h3 id=三-mcache>(三) mcache<a hidden class=anchor aria-hidden=true href=#三-mcache>#</a></h3><p>mcache 与 TCMalloc 中的 ThreadCache 类似，mcache 保存的是各种大小的 Span，
并按 Span class 分类，小对象直接从 mcache 分配内存，它起到了缓存的作用，
并且可以无锁访问。</p><p>但 mcache 和 ThreadCache 也有不同点，TCMalloc 中是每个线程一个 ThreadCache，
go 中是每个 P 拥有一个 mcache，因为在 go 程序中，当前最多有 GOMAXPROCS 个线程在运行，
所以最多需要 GOMAXPROCS 个 mcache 就可以保证各线程对 mcache 的无锁访问。
下图是 G、P、M 三者之间的关系：</p><p><img loading=lazy src=/img/code/go-gc/gpm.png alt=goroutine调度原理图></p><h3 id=四-mcentral>(四) mcentral<a hidden class=anchor aria-hidden=true href=#四-mcentral>#</a></h3><p>mcentral 与 TCMalloc 中的 CentralCache 类似，是所有线程共享的缓存，需要加锁访问。
它按 Span class 对 Span 分类，串联成链表，当 mcache 的某个级别 Span 的内存被分配光时，
它会向 mcentral 申请一个当前级别的 Span。</p><p>但 mcentral 与 CentralCache 也有不同点，
CentralCache 是每个级别的 Span 有一个链表，
mcentral 是每个级别的 Span 有两个链表。</p><h3 id=五-mheap>(五) mheap<a hidden class=anchor aria-hidden=true href=#五-mheap>#</a></h3><p>mheap 与 TCMalloc 的 PageHeap 类似，它是堆内存的抽象，把从 OS 申请出的内存页组织成 Span，
并保存起来。当 mcentral 的 Span 不够用时会向 mheap 申请，
mheap 的 Span 不够用时会向 OS 申请，把从 OS 申请的内存页生成 Span 组织起来，需要加锁访问。</p><p>但 mheap 与 PageHeap 也有不同点，
mheap 把 Span 组织成了树结构，而不是链表，并且还是两棵树，
然后把 Span 分配到 heapArena 进行管理，它包含地址映射和 Span 是否包含指针等位图，
这样做的主要原因是为了更高效的利用内存：分配、回收和再利用。</p><h3 id=六-内存分配>(六) 内存分配<a hidden class=anchor aria-hidden=true href=#六-内存分配>#</a></h3><p>TCMalloc 的内存分类分为：小、中、大对象， go 分为：Tiny、小、大对象。
Tiny 对象指大小在 1Byte 到 16Byte 之间且不包含指针的对象。
小对象和大对象只用大小划定，无其他区分，
小对象大小在 16Byte 到 32KB 之间，
大对象大小大于 32KB。</p><p>go 的内存管理基本单位是 Span，且 Span 有不同的规格，想要区分出不同的 Span，
就得有个标识，每个 Span 通过 spanclass 标识属于哪种规格的 Span，
go 的 Span 一共有 67 种，具体如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// from runtime/sizeclasses.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// class  bytes/obj  bytes/span  objects  tail waste  max waste  min align
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     1          8        8192     1024           0     87.50%          8
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     2         16        8192      512           0     43.75%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     3         24        8192      341           8     29.24%          8
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     4         32        8192      256           0     21.88%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     5         48        8192      170          32     31.52%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     6         64        8192      128           0     23.44%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     7         80        8192      102          32     19.07%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     8         96        8192       85          32     15.95%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     9        112        8192       73          16     13.56%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    10        128        8192       64           0     11.72%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    11        144        8192       56         128     11.82%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    12        160        8192       51          32      9.73%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    13        176        8192       46          96      9.59%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    14        192        8192       42         128      9.25%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    15        208        8192       39          80      8.12%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    16        224        8192       36         128      8.15%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    17        240        8192       34          32      6.62%         16
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    18        256        8192       32           0      5.86%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    19        288        8192       28         128     12.16%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    20        320        8192       25         192     11.80%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    21        352        8192       23          96      9.88%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    22        384        8192       21         128      9.51%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    23        416        8192       19         288     10.71%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    24        448        8192       18         128      8.37%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    25        480        8192       17          32      6.82%         32
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    26        512        8192       16           0      6.05%        512
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    27        576        8192       14         128     12.33%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    28        640        8192       12         512     15.48%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    29        704        8192       11         448     13.93%         64
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    30        768        8192       10         512     13.94%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    31        896        8192        9         128     15.52%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    32       1024        8192        8           0     12.40%       1024
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    33       1152        8192        7         128     12.41%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    34       1280        8192        6         512     15.55%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    35       1408       16384       11         896     14.00%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    36       1536        8192        5         512     14.00%        512
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    37       1792       16384        9         256     15.57%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    38       2048        8192        4           0     12.45%       2048
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    39       2304       16384        7         256     12.46%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    40       2688        8192        3         128     15.59%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    41       3072       24576        8           0     12.47%       1024
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    42       3200       16384        5         384      6.22%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    43       3456       24576        7         384      8.83%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    44       4096        8192        2           0     15.60%       4096
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    45       4864       24576        5         256     16.65%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    46       5376       16384        3         256     10.92%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    47       6144       24576        4           0     12.48%       2048
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    48       6528       32768        5         128      6.23%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    49       6784       40960        6         256      4.36%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    50       6912       49152        7         768      3.37%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    51       8192        8192        1           0     15.61%       8192
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    52       9472       57344        6         512     14.28%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    53       9728       49152        5         512      3.64%        512
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    54      10240       40960        4           0      4.99%       2048
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    55      10880       32768        3         128      6.24%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    56      12288       24576        2           0     11.45%       4096
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    57      13568       40960        3         256      9.99%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    58      14336       57344        4           0      5.35%       2048
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    59      16384       16384        1           0     12.49%       8192
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    60      18432       73728        4           0     11.11%       2048
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    61      19072       57344        3         128      3.57%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    62      20480       40960        2           0      6.87%       4096
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    63      21760       65536        3         256      6.25%        256
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    64      24576       24576        1           0     11.45%       8192
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    65      27264       81920        3         128     10.00%        128
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    66      28672       57344        2           0      4.91%       4096
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    67      32768       32768        1           0     12.50%       8192
</span></span></span></code></pre></div><p>由上表可见，最大的对象大小为 32KB，超过 32KB 大小的由特殊 class 表示，
该 class ID 为 0，每个 class 只包含一个对象。</p><p>内存大小转换，有 3 个数组，对应下图中的三个箭头：</p><ul><li>class_to_size</li><li>size_to_class</li><li>class_to_allocnpages</li></ul><p><img loading=lazy src=/img/code/go-gc/mem-transfer.png alt=go内存大小转换></p><p>class 1 的对象大小为 8Byte，所以 class_to_size[1] = 8；
span 大小是 8KB，为 1 页（因为 go 内存管理以 8KB 为一页），
所以 class_to_allocnpages[1] = 1，下面是源码中大小转换数组：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_MaxSmallSize</span>   = <span style=color:#ae81ff>32768</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>smallSizeDiv</span>    = <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>smallSizeMax</span>    = <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>largeSizeDiv</span>    = <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_NumSizeClasses</span> = <span style=color:#ae81ff>68</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_PageShift</span>      = <span style=color:#ae81ff>13</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>class_to_size</span> = [<span style=color:#a6e22e>_NumSizeClasses</span>]<span style=color:#66d9ef>uint16</span>{<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>80</span>, <span style=color:#ae81ff>96</span>, <span style=color:#ae81ff>112</span>, <span style=color:#ae81ff>128</span>, <span style=color:#ae81ff>144</span>, <span style=color:#ae81ff>160</span>, <span style=color:#ae81ff>176</span>, <span style=color:#ae81ff>192</span>, <span style=color:#ae81ff>208</span>, <span style=color:#ae81ff>224</span>, <span style=color:#ae81ff>240</span>, <span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>288</span>, <span style=color:#ae81ff>320</span>, <span style=color:#ae81ff>352</span>, <span style=color:#ae81ff>384</span>, <span style=color:#ae81ff>416</span>, <span style=color:#ae81ff>448</span>, <span style=color:#ae81ff>480</span>, <span style=color:#ae81ff>512</span>, <span style=color:#ae81ff>576</span>, <span style=color:#ae81ff>640</span>, <span style=color:#ae81ff>704</span>, <span style=color:#ae81ff>768</span>, <span style=color:#ae81ff>896</span>, <span style=color:#ae81ff>1024</span>, <span style=color:#ae81ff>1152</span>, <span style=color:#ae81ff>1280</span>, <span style=color:#ae81ff>1408</span>, <span style=color:#ae81ff>1536</span>, <span style=color:#ae81ff>1792</span>, <span style=color:#ae81ff>2048</span>, <span style=color:#ae81ff>2304</span>, <span style=color:#ae81ff>2688</span>, <span style=color:#ae81ff>3072</span>, <span style=color:#ae81ff>3200</span>, <span style=color:#ae81ff>3456</span>, <span style=color:#ae81ff>4096</span>, <span style=color:#ae81ff>4864</span>, <span style=color:#ae81ff>5376</span>, <span style=color:#ae81ff>6144</span>, <span style=color:#ae81ff>6528</span>, <span style=color:#ae81ff>6784</span>, <span style=color:#ae81ff>6912</span>, <span style=color:#ae81ff>8192</span>, <span style=color:#ae81ff>9472</span>, <span style=color:#ae81ff>9728</span>, <span style=color:#ae81ff>10240</span>, <span style=color:#ae81ff>10880</span>, <span style=color:#ae81ff>12288</span>, <span style=color:#ae81ff>13568</span>, <span style=color:#ae81ff>14336</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>18432</span>, <span style=color:#ae81ff>19072</span>, <span style=color:#ae81ff>20480</span>, <span style=color:#ae81ff>21760</span>, <span style=color:#ae81ff>24576</span>, <span style=color:#ae81ff>27264</span>, <span style=color:#ae81ff>28672</span>, <span style=color:#ae81ff>32768</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>class_to_allocnpages</span> = [<span style=color:#a6e22e>_NumSizeClasses</span>]<span style=color:#66d9ef>uint8</span>{<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>4</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>class_to_divmagic</span> = [<span style=color:#a6e22e>_NumSizeClasses</span>]<span style=color:#66d9ef>uint32</span>{<span style=color:#ae81ff>0</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>8</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>16</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>24</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>32</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>48</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>64</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>80</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>96</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>112</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>128</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>144</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>160</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>176</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>192</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>208</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>224</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>240</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>256</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>288</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>320</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>352</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>384</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>416</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>448</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>480</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>512</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>576</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>640</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>704</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>768</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>896</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1024</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1152</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1280</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1408</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1536</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>1792</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2048</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2304</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2688</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>3072</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>3200</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>3456</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>4096</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>4864</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>5376</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>6144</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>6528</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>6784</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>6912</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>8192</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>9472</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>9728</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>10240</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>10880</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>12288</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>13568</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>14336</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>16384</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>18432</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>19072</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>20480</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>21760</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>24576</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>27264</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>28672</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, ^uint32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>32768</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>size_to_class8</span> = [<span style=color:#a6e22e>smallSizeMax</span><span style=color:#f92672>/</span><span style=color:#a6e22e>smallSizeDiv</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]<span style=color:#66d9ef>uint8</span>{<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>32</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>size_to_class128</span> = [(<span style=color:#a6e22e>_MaxSmallSize</span><span style=color:#f92672>-</span><span style=color:#a6e22e>smallSizeMax</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>largeSizeDiv</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]<span style=color:#66d9ef>uint8</span>{<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>33</span>, <span style=color:#ae81ff>34</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>38</span>, <span style=color:#ae81ff>38</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>42</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>53</span>, <span style=color:#ae81ff>53</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>67</span>}
</span></span></code></pre></div><p>为对象寻找 Span 的流程如下：</p><ul><li>计算对象所需内存大小 size。</li><li>根据 size 到 size class 映射，得到 size class。</li><li>根据 size class 和对象是否包含指针，得到 span class。</li><li>获取该 span class 指向的 span。</li></ul><p>以分配一个包含指针，大小为 20Byte 的对象为例，根据映射表，
size class 3，它的对象大小范围是 (16, 24]Byte，20Byte 刚好在这之间，
所以此对象的 size class 为 3，size class 到 span class 的计算如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>spanClass</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// noscan 为 false 代表对象包含指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makeSpanClass</span>(<span style=color:#a6e22e>sizeclass</span> <span style=color:#66d9ef>uint8</span>, <span style=color:#a6e22e>noscan</span> <span style=color:#66d9ef>bool</span>) <span style=color:#a6e22e>spanClass</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>spanClass</span>(<span style=color:#a6e22e>sizeclass</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#ae81ff>1</span>) | <span style=color:#a6e22e>spanClass</span>(<span style=color:#a6e22e>bool2int</span>(<span style=color:#a6e22e>noscan</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所以对应的 span class 为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>span</span> <span style=color:#a6e22e>class</span> = <span style=color:#ae81ff>3</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#ae81ff>1</span> | <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 即 110 | 000 = 6
</span></span></span></code></pre></div><p>所以该对象需要的是 span class 6 指向的 span，自此，小对象内存分配完成。</p><p>源码中三段分别针对 tiny、小、大对象进行分配，下面只详细贴出小对象分配内存的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>maxSmallSize</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>noscan</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>size</span> &lt; <span style=color:#a6e22e>maxTinySize</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// tiny 对象分配 (&lt; 16B)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 小对象分配 (16B ~ 32KB)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sizeclass</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 先计算 sizeclass
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>smallSizeMax</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sizeclass</span> = <span style=color:#a6e22e>size_to_class8</span>[<span style=color:#a6e22e>divRoundUp</span>(<span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>smallSizeDiv</span>)]
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sizeclass</span> = <span style=color:#a6e22e>size_to_class128</span>[<span style=color:#a6e22e>divRoundUp</span>(<span style=color:#a6e22e>size</span><span style=color:#f92672>-</span><span style=color:#a6e22e>smallSizeMax</span>, <span style=color:#a6e22e>largeSizeDiv</span>)]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span> = uintptr(<span style=color:#a6e22e>class_to_size</span>[<span style=color:#a6e22e>sizeclass</span>])
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 再计算 span class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>spc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeSpanClass</span>(<span style=color:#a6e22e>sizeclass</span>, <span style=color:#a6e22e>noscan</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 分配对应的 span (是一个 *mspan)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>span</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>alloc</span>[<span style=color:#a6e22e>spc</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nextFreeFast</span>(<span style=color:#a6e22e>span</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nextFree</span>(<span style=color:#a6e22e>spc</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>needzero</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>needzero</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>memclrNoHeapPointers</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>v</span>), <span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 大对象分配 (&gt; 32KB)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>span</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>allocLarge</span>(<span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>noscan</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>大对象（> 32KB）直接在 mheap 上分配，首先计算出需要的内存页数和 span class，
然后优先从 free 中搜索可用的 span，如果没找到，会从 scav 中搜索可用的 span，
如果还没找到，则向 OS 申请内存，再重新搜索两棵树，必然能找到 span。
如果找到的 span 比需要的 span 大，则把 span 分割成 2 个 span，
一个刚好是需求大小，把剩下的 span 再加入到 free 中去。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// from runtime/mcache.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mcache</span>) <span style=color:#a6e22e>allocLarge</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>noscan</span> <span style=color:#66d9ef>bool</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span><span style=color:#f92672>+</span><span style=color:#a6e22e>_PageSize</span> &lt; <span style=color:#a6e22e>size</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;out of memory&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// _PageShift = 13，从这里就能看出一页是 8KB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>npages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>_PageShift</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>_PageMask</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>npages</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Deduct credit for this span allocation and sweep if
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// necessary. mHeap_Alloc will also sweep npages, so this only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// pays the debt down to npage pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>deductSweepCredit</span>(<span style=color:#a6e22e>npages</span><span style=color:#f92672>*</span><span style=color:#a6e22e>_PageSize</span>, <span style=color:#a6e22e>npages</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>spc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeSpanClass</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>noscan</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>alloc</span>(<span style=color:#a6e22e>npages</span>, <span style=color:#a6e22e>spc</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;out of memory&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stats</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>heapStats</span>.<span style=color:#a6e22e>acquire</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadduintptr</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>largeAlloc</span>, <span style=color:#a6e22e>npages</span><span style=color:#f92672>*</span><span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadduintptr</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>largeAllocCount</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>heapStats</span>.<span style=color:#a6e22e>release</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Update heapLive.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>update</span>(int64(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>npages</span><span style=color:#f92672>*</span><span style=color:#a6e22e>pageSize</span>), <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Put the large span in the mcentral swept list so that it&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// visible to the background sweeper.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>central</span>[<span style=color:#a6e22e>spc</span>].<span style=color:#a6e22e>mcentral</span>.<span style=color:#a6e22e>fullSwept</span>(<span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>sweepgen</span>).<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>limit</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>size</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>heapBitsForAddr</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>()).<span style=color:#a6e22e>initSpan</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=三垃圾回收>三、垃圾回收<a hidden class=anchor aria-hidden=true href=#三垃圾回收>#</a></h2><h3 id=一-标记-清除>(一) 标记-清除<a hidden class=anchor aria-hidden=true href=#一-标记-清除>#</a></h3><p><img loading=lazy src=/img/code/go-gc/mark.gif alt=标记></p><h3 id=二-三色可达性分析>(二) 三色可达性分析<a hidden class=anchor aria-hidden=true href=#二-三色可达性分析>#</a></h3><p><img loading=lazy src=/img/code/go-gc/three-color.gif alt=标记></p><h3 id=三-gc-触发>(三) gc 触发<a hidden class=anchor aria-hidden=true href=#三-gc-触发>#</a></h3><h3 id=四-gc-过程>(四) gc 过程<a hidden class=anchor aria-hidden=true href=#四-gc-过程>#</a></h3><ul><li>gcStart</li><li>Mark</li><li>Sweep</li></ul><h1 id=参考文献>参考文献<a hidden class=anchor aria-hidden=true href=#参考文献>#</a></h1><ul><li><a href=https://mp.weixin.qq.com/s/7Yjk9oeOPSm1h1SEnNh13A>超干货！彻底搞懂Golang内存管理和垃圾回收</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://theone-daxia.github.io/tags/go-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/>go 内存管理</a></li><li><a href=https://theone-daxia.github.io/tags/go-gc/>go gc</a></li></ul><nav class=paginav><a class=prev href=https://theone-daxia.github.io/blog/code/github/clone-private/><span class=title>« Prev Page</span><br><span>github 克隆自己的私有仓库</span></a>
<a class=next href=https://theone-daxia.github.io/blog/code/go/recursive-mutex/><span class=title>Next Page »</span><br><span>go实现可重入锁</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://theone-daxia.github.io/>冲和</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>